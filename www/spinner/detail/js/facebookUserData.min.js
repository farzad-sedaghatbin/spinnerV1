var FacebookUserData={_userData:{},_onLoginFinishedCallbacks:[],_loginFinished:false,_loggedIn:false,_authorized:true,getUserData:function(){return this._userData},init:function(){FB.init({appId:this._getFacebookBotAppId(),xfbml:true,version:"v2.8"})},tryLogin:function(dataRetrievedCallback){var oThis=this;FB.getLoginStatus(function(response){if(response.status==="connected"){oThis._processFacebookAuthResponse(response,function(){oThis._loggedIn=true;oThis._onLoginFinished();dataRetrievedCallback(oThis.getUserData())})}else{oThis._handleLoginDialog();oThis._onLoginFinished()}})},forceRelogin:function(){this._handleLoginDialog()},forceConnect:function(){this._handleLoginDialog(true)},addAfterLoginCallback:function(callback){if(!this._loginFinished){this._onLoginFinishedCallbacks.push(callback)}else{typeof callback=="function"&&callback()}},isLoggedIn:function(){return this._loggedIn},isAuthorized:function(){return this._authorized},isLoginRequestFinished:function(){return this._loginFinished},_onLoginFinished:function(){this._loginFinished=true;for(var i=0;i<this._onLoginFinishedCallbacks.length;i++){var callback=this._onLoginFinishedCallbacks[i]();typeof callback=="function"&&callback()}},_processFacebookAuthResponse:function(response,dataRetrievedCallback){var oThis=this;oThis._userData.app_scoped_user_id=response.authResponse.userID;oThis._userData.accessToken=response.authResponse.accessToken;FB.api("/me/permissions",function(response){var granted=[];for(i=0;i<response.data.length;i++){if(response.data[i].status=="granted"){granted.push(response.data[i].permission)}}if(granted.indexOf("user_friends")==-1){if(!oThis._permissionRequestAlreadyMade()){oThis._handleLoginDialog()}else{oThis._authorized=false}}if(granted.indexOf("email")==-1){if(!oThis._permissionRequestAlreadyMade()){oThis._handleLoginDialog()}else{oThis._authorized=false}}});FB.api("/me",{fields:"name, email, gender, picture.width(640), locale, friends"},function(response){if(!response.error){if(response.email){oThis._userData.email=response.email}oThis._userData.facebookName=response.name;oThis._userData.gender=response.gender;oThis._userData.photo=response.picture.data.url;oThis._userData.locale=response.locale}MessengerExtensions.getUserID(function success(uids){oThis._userData.user_id=uids.psid;typeof dataRetrievedCallback=="function"&&dataRetrievedCallback(oThis.getUserData())},function error(err){typeof dataRetrievedCallback=="function"&&dataRetrievedCallback(oThis.getUserData())})})},_handleLoginDialog:function(){if(!this._didUserDenyFacebookPermissions()){url=window.location.href;window.location.href="https://www.facebook.com/v2.8/dialog/oauth"+"?client_id="+this._getFacebookBotAppId()+"&response_type=token"+"&redirect_uri="+window.location.href.split("?")[0]+"?requestMade=1"+"&scope=email,user_friends"+"&auth_type=rerequest"}},_permissionRequestAlreadyMade:function(){var queryString=window.location.search.substring(1).split("&")[0].split("=");return queryString[0]=="requestMade"},_didUserDenyFacebookPermissions:function(){var queryParams=window.location.search.substring(1).split("&");var isDenied=false;for(var i=0;i<queryParams.length;i++){var queryParam=queryParams[i].split("=");if(queryParam[0]==="error"&&queryParam[1]==="access_denied"){isDenied=true;break}}return isDenied},_parseAccessTokenFromFacebookLoginUrl:function(){var hash=window.location.hash.substring(1).split("&");hash[0]=hash[0].split("=");hash[1]=hash[1].split("=");var hashObject={};hashObject[hash[0][0]]=hash[0][1];hashObject[hash[1][0]]=hash[1][1];return hashObject.access_token},_getFacebookBotAppId:function(){return $("body").attr("data-facebook-bot-app-id")}};